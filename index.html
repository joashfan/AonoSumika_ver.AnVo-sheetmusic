<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ao no Sumika (全曲導引版) - 練琴小幫手 v2.0</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a202c; color: white; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        h1 { color: #60a5fa; margin-bottom: 5px; }
        p { color: #94a3b8; margin-bottom: 20px; font-size: 0.9em; }
        
        .controls { background: #2d3748; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: center; margin-bottom: 20px; width: 100%; max-width: 800px; }
        
        .btn-group { display: flex; gap: 10px; }
        button { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #2563eb; transform: translateY(-1px); }
        button.active-section { background: #10b981; pointer-events: none; }
        button.stop { background: #ef4444; }
        
        .slider-group { display: flex; flex-direction: column; align-items: center; min-width: 120px; }
        label { font-size: 12px; color: #cbd5e1; margin-bottom: 5px; }
        input[type=range] { width: 100%; cursor: pointer; }

        /* Piano Styling */
        .piano-wrapper { overflow-x: auto; max-width: 100%; padding-bottom: 10px; display: flex; justify-content: center; }
        .piano-container { position: relative; display: flex; padding: 10px; background: #0f172a; border-radius: 8px; border-top: 4px solid #334155; }
        .key { position: relative; width: 36px; height: 160px; background: white; border-radius: 0 0 4px 4px; margin: 0 1px; z-index: 1; border-bottom: 3px solid #ccc; }
        .key.black { width: 20px; height: 100px; background: #111; position: absolute; z-index: 2; margin-left: -11px; border-bottom: 3px solid #000; }
        
        /* Active State */
        .key.active { background: #60a5fa !important; transform: scaleY(0.98); border-bottom: none; }
        .key.black.active { background: #3b82f6 !important; }

        .key-text { position: absolute; bottom: 5px; width: 100%; text-align: center; color: #ccc; font-size: 9px; pointer-events: none; }
        
        .info-panel { background: #2d3748; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: left; max-width: 600px; line-height: 1.6; }
        .highlight { color: #facc15; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Ao no Sumika (完整結構版)</h1>
    <p>針對 An Vo 編曲版樂譜製作：前奏 -> 主歌 -> 副歌</p>

    <div class="controls">
        <div class="slider-group">
            <label>練習速度: <span id="speedVal">100% (原速)</span></label>
            <input type="range" id="speedSlider" min="0.4" max="1.1" step="0.1" value="1.0">
        </div>
        <button id="stopBtn" class="stop">■ 停止</button>
    </div>

    <div class="controls">
        <span style="color:#aaa; font-size:12px; width:100%; text-align:center;">選擇練習段落 (點擊播放)：</span>
        <div class="btn-group">
            <button onclick="playSection('intro')">1. 前奏 (Intro)</button>
            <button onclick="playSection('verse')">2. 主歌 (Verse)</button>
            <button onclick="playSection('chorus')">3. 副歌 (Chorus)</button>
        </div>
    </div>

    <div class="piano-wrapper">
        <div class="piano-container" id="piano">
            </div>
    </div>

    <div class="info-panel" id="hintBox">
        請選擇上方的一個段落開始練習。
    </div>

<script>
    const context = new (window.AudioContext || window.webkitAudioContext)();
    const pianoEl = document.getElementById('piano');
    const hintBox = document.getElementById('hintBox');
    const speedSlider = document.getElementById('speedSlider');
    const speedVal = document.getElementById('speedVal');

    // --- Piano Setup ---
    const notes = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
    const startOct = 2, endOct = 7;
    const keyElements = {};
    const allNotes = [];

    // Build Keys
    for(let i=startOct; i<=endOct; i++) notes.forEach(n => allNotes.push(n+i));
    
    allNotes.forEach((n, idx) => {
        if(!n.includes('b')) {
            const wKey = document.createElement('div');
            wKey.className = 'key white';
            wKey.innerHTML = `<div class="key-text">${n}</div>`;
            pianoEl.appendChild(wKey);
            keyElements[n] = wKey;
            
            let next = allNotes[idx+1];
            if(next && next.includes('b')) {
                const bKey = document.createElement('div');
                bKey.className = 'key black';
                wKey.appendChild(bKey);
                keyElements[next] = bKey;
            }
        }
    });

    // --- Sound Engine ---
    function playTone(note, duration) {
        if(context.state === 'suspended') context.resume();
        const osc = context.createOscillator();
        const gain = context.createGain();
        osc.type = 'triangle'; 
        
        // Freq Calc
        const cleanNote = note.replace('Db', 'C#').replace('Eb', 'D#').replace('Gb', 'F#').replace('Ab', 'G#').replace('Bb', 'A#');
        const semitones = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'].indexOf(cleanNote.slice(0,-1)) - 9 + (parseInt(cleanNote.slice(-1)) - 4) * 12;
        osc.frequency.value = 440 * Math.pow(2, semitones / 12);
        
        osc.connect(gain);
        gain.connect(context.destination);
        osc.start();
        
        const now = context.currentTime;
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.2, now + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
        osc.stop(now + duration + 0.1);

        const el = keyElements[note];
        if(el) {
            el.classList.add('active');
            setTimeout(() => el.classList.remove('active'), duration * 800);
        }
    }

    // --- Song Data (The Teacher) ---
    // Format: [beat_start, note, duration]
    // BPM 150
    
    const sections = {
        'intro': {
            hint: "【前奏 Bars 1-4】<br>這是整首歌的靈魂。注意左手 (Db, Bb, Gb) 是根音支撐，右手是切分音節奏。<br><span class='highlight'>重點：</span>第 2 小節的 Bb5 -> Ab5 要連貫。",
            notes: [
                // Melody RH
                [0, 'Db6', 0.5], [0.5, 'C6', 0.5], [1.0, 'Ab5', 0.5], [1.5, 'F5', 0.5], 
                [2.0, 'Eb5', 0.5], [2.5, 'Db5', 0.5], [3.0, 'Ab4', 0.5], [3.5, 'Db5', 0.5],
                [4.0, 'Bb5', 1.0], [5.0, 'Ab5', 1.0], [6.0, 'F5', 1.5], [7.5, 'Eb5', 0.5],
                // Bass LH
                [0, 'Db3', 3.5], [4, 'Bb2', 3.5], [8, 'Gb2', 3.5]
            ]
        },
        'verse': {
            hint: "【主歌 Bars 10-17】 (對應樂譜 Page 1 下半部)<br>這裡音樂變安靜了。左手是輕柔的雙音，右手在說故事。<br><span class='highlight'>樂譜細節：</span>第 10 小節有一個 pickup (弱起拍)，從 F5 開始。",
            notes: [
                // Pickup Bar 10
                [0.0, 'F5', 0.5], [0.5, 'Gb5', 0.5], [1.0, 'F5', 0.5], [1.5, 'Eb5', 0.5], [2.0, 'Db5', 2.0],
                // Bar 11
                [4.0, 'F5', 0.5], [4.5, 'Gb5', 0.5], [5.0, 'F5', 0.5], [5.5, 'Eb5', 0.5], [6.0, 'Bb4', 2.0],
                // Bass LH - lighter
                [0, 'Gb2', 2], [2, 'Ab2', 2], [4, 'Bb2', 2], [6, 'F2', 2]
            ]
        },
        'chorus': {
            hint: "【副歌 Bars 33+】 (對應樂譜 Page 2 中段)<br>高潮來了！右手通常是八度音 (Octaves)，這裡我用單音示範旋律位置。<br><span class='highlight'>挑戰：</span>這段旋律跟前奏很像，但更高昂，注意高音 Db6 的爆發力。",
            notes: [
                // Bar 33 (Similar to Intro but higher energy)
                [0, 'Db6', 0.75], [0.75, 'C6', 0.25], [1.0, 'Ab5', 0.5], [1.5, 'F5', 0.5],
                [2.0, 'Eb5', 0.5], [2.5, 'Db5', 0.5], [3.0, 'Ab5', 0.5], [3.5, 'Db6', 0.5],
                // Bar 34
                [4.0, 'Bb5', 1.0], [5.0, 'Ab5', 1.0], [6.0, 'F5', 1.0], 
                // Bass LH - Driving
                [0, 'Gb2', 1], [1, 'Gb3', 1], [2, 'Ab2', 1], [3, 'Ab3', 1]
            ]
        }
    };

    let timeouts = [];
    const bpm = 150;

    function playSection(sectionKey) {
        stopAll();
        const sec = sections[sectionKey];
        hintBox.innerHTML = sec.hint;
        
        const speed = parseFloat(speedSlider.value);
        const beatTime = 60 / (bpm * speed);

        sec.notes.forEach(n => {
            const time = n[0] * beatTime * 1000;
            const dur = n[2] * beatTime;
            timeouts.push(setTimeout(() => playTone(n[1], dur), time));
        });
    }

    function stopAll() {
        timeouts.forEach(clearTimeout);
        timeouts = [];
        document.querySelectorAll('.key').forEach(k => k.classList.remove('active'));
    }

    document.getElementById('stopBtn').onclick = stopAll;
    speedSlider.oninput = function() {
        speedVal.innerText = Math.round(this.value * 100) + "%";
    }
</script>
</body>
</html>